# Lambda Deployment Script – `deploy_lambda.py`

This script publishes a Lambda function to AWS and updates its **unversioned ARN** in SSM Parameter Store. It is the standard way to deploy Lambda functions from the `aws-openapi` repo into an Adage-managed infrastructure.

---

## What It Does

* Packages the Lambda function and dependencies into a ZIP
* Uploads the ZIP to AWS Lambda
* Publishes a new version (for visibility and AWS bookkeeping)
* Writes the **unversioned function ARN** to:

  ```
  /iac/lambda/<nickname>/runtime
  ```

This makes the Lambda resolvable by nickname across environments. It always uses `$LATEST`.

---

## Usage

From the root of the `aws-openapi` repository:

```bash
python scripts/deploy_lambda.py echo
```

This will:

1. Package Python files and `requirements.txt` (if present)
2. Upload `dist/echo.zip` to AWS Lambda
3. Publish a new version
4. Write the base function ARN (no `:version`) to:

   ```
   /iac/lambda/echo/runtime
   ```

---

## Lambda Directory Structure

Each Lambda must live under `lambdas/<nickname>/`:

```
lambdas/
└── echo/
    ├── main.py
    ├── requirements.txt     # optional
    └── dist/
        └── echo.zip  # auto-generated by deploy_lambda
```

---

## Shared Build Logic

The script:

* Recursively includes all `.py` files in the Lambda directory
* Installs any dependencies from `requirements.txt` into the build
* Packages everything into a ZIP in `dist/`

---

## After Publishing

Once published, other components like `serverless-api` will resolve the Lambda runtime using:

```json
{
  "arn": "arn:aws:lambda:us-east-1:123456789012:function:echo"
}
```

from:

```
/iac/lambda/echo/runtime
```

This points to the `$LATEST` version of the function.

---

## Notes

* The Lambda function must already exist in AWS — create it via Terraform or manually
* AWS credentials must be available via `AWS_PROFILE`, `~/.aws/credentials`, or environment variables
* This script is safe to run repeatedly
* Lambdas can be published independently from any Git branch — useful for testing, staging, and hotfixes
